<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="pr2database">
<title>Train DECIPHER with PR2 â€¢ pr2database</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Train DECIPHER with PR2">
<meta property="og:description" content="pr2database">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">pr2database</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">4.14.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/pr2database.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>PR2 shiny application</h6>
    <a class="dropdown-item" href="../articles/vignette-shiny-presentation.html">General presentation</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Examples of use</h6>
    <a class="dropdown-item" href="../articles/pr2_01_stats.html">PR2 statistics</a>
    <a class="dropdown-item" href="../articles/pr2_02_silva.html">Comparing PR2 vs Silva annotations</a>
    <a class="dropdown-item" href="../articles/pr2_03_geo_origin.html">Plotting sequence location</a>
    <a class="dropdown-item" href="../articles/pr2_04_decipher.html">Train DECIPHER with PR2</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Train DECIPHER with PR2</h1>
                        <h4 data-toc-skip class="author">Daniel
Vaulot</h4>
            
      
      <small class="dont-index">Source: <a href="NA/NA/NA/blob/HEAD/vignettes/pr2_04_decipher.Rmd"><code>vignettes/pr2_04_decipher.Rmd</code></a></small>
      <div class="d-none name"><code>pr2_04_decipher.Rmd</code></div>
    </div>

    
    
<p>Currently there are two major functions under R to assign
metabarcoding sequences: * AssignTax from the dada2 package (based on
the RDP Naive Bayesian assigner) * IDTax from the DECIPHER package (<a href="https://doi.org/10.1186/s40168-018-0521-5" class="external-link">Murali, A., Bhargava,
A., &amp; Wright, E. S. (2018). IDTAXA: A novel approach for accurate
taxonomic classification of microbiome sequences. Microbiome, 6(1),
140.</a>)</p>
<p>IDTax requires first to train the model which can takes a bit of time
depending on the database size. However, after the model is trained
assignement is quite fast.</p>
<p>In this tutorial we explain how to train the model and assign a small
metabarcoding dataset. The original code originates from <a href="https://www.bioconductor.org/packages/release/bioc/vignettes/DECIPHER/inst/doc/ClassifySequences.pdf" class="external-link">DECIPHER
manual</a></p>
<p>Here we perform the training on a very small set of 100 sequences.
Typically each training iteration for the full PR2 database will take
about 7 hours on 2.3 GHz PC with 8 processors and 32 G of memory. In
contrast on the ABIMS Roscoff server using 32G and 1 processor, one
iteration took 20 min. The trained dataset is about 300 Mb. It is
available as part of the latest <a href="https://github.com/pr2database/pr2database/releases" class="external-link">PR2
version</a>.</p>
<div class="section level2">
<h2 id="load-the-necessary-libraries">Load the necessary libraries<a class="anchor" aria-label="anchor" href="#load-the-necessary-libraries"></a>
</h2>
<ul>
<li>See instructions on the <a href="https://www.bioconductor.org/packages/release/bioc/html/DECIPHER.html" class="external-link">Bioconductor
page</a> to install DECIPHER</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">DECIPHER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/leeper/rio" class="external-link">rio</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT" class="external-link">DT</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-parameters-and-files">Define parameters and files<a class="anchor" aria-label="anchor" href="#define-parameters-and-files"></a>
</h2>
<p>Please refer to <a href="https://www.bioconductor.org/packages/release/bioc/vignettes/DECIPHER/inst/doc/ClassifySequences.pdf" class="external-link">DECIPHER
manual</a> for information about the different parameters.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file_training</span> <span class="op">=</span> <span class="st">"examples/pr2_version_4.14.0_SSU_dada2.fasta.gz"</span></span>
<span><span class="va">file_trained</span> <span class="op">=</span> <span class="st">"examples/pr2_version_4.14.0_SSU.trained.sample.rds"</span></span>
<span><span class="va">file_problems</span> <span class="op">=</span> <span class="st">"examples/pr2_version_4.14.0_SSU.problems.sample.rds"</span></span>
<span></span>
<span><span class="va">maxGroupSize</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># max sequences per label (&gt;= 1)</span></span>
<span><span class="va">allowGroupRemoval</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span></span>
<span><span class="va">maxIterations</span> <span class="op">&lt;-</span> <span class="fl">3</span> <span class="co"># must be &gt;= 1</span></span>
<span>  </span></code></pre></div>
</div>
<div class="section level2">
<h2 id="train-model">Train model<a class="anchor" aria-label="anchor" href="#train-model"></a>
</h2>
<div class="section level3">
<h3 id="iterations">Iterations<a class="anchor" aria-label="anchor" href="#iterations"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read data -------------------------------------------------------------</span></span>
<span></span>
<span><span class="va">seqs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Biostrings/man/XStringSet-io.html" class="external-link">readDNAStringSet</a></span><span class="op">(</span><span class="va">file_training</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample 1000 sequences  ---------------------------------------------------</span></span>
<span><span class="va">seqs</span> <span class="op">=</span> <span class="va">seqs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">seqs</span><span class="op">)</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="co"># Taxo groups -------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># obtain the taxonomic assignments</span></span>
<span><span class="va">groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">seqs</span><span class="op">)</span> <span class="co"># sequence names</span></span>
<span></span>
<span><span class="co"># All taxos must start with "Root;"</span></span>
<span><span class="va">groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="st">"Root;"</span>,<span class="va">groups</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">seqs</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">groups</span></span>
<span></span>
<span><span class="va">groupCounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">groups</span><span class="op">)</span></span>
<span><span class="va">u_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">groupCounts</span><span class="op">)</span> <span class="co"># unique groups</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of groups: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">u_groups</span><span class="op">)</span>, <span class="st">'\n'</span><span class="op">)</span> <span class="co"># number of group</span></span>
<span><span class="co">#&gt; Number of groups:  742</span></span>
<span></span>
<span><span class="va">taxid</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># Pruning group size ---</span></span>
<span></span>
<span><span class="va">remove</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">seqs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">groupCounts</span> <span class="op">&gt;</span> <span class="va">maxGroupSize</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">groups</span><span class="op">==</span><span class="va">u_groups</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span>, <span class="va">maxGroupSize</span><span class="op">)</span></span>
<span>  <span class="va">remove</span><span class="op">[</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="va">keep</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of sequences eliminated: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">remove</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of sequences eliminated:  38</span></span>
<span></span>
<span><span class="co"># Iteratively train classifier -----------------------------------------------</span></span>
<span></span>
<span><span class="va">probSeqsPrev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># suspected problem sequences from prior iteration</span></span>
<span><span class="va">df.problems</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of iterations:"</span>, <span class="va">maxIterations</span>, <span class="st">"\n"</span>, sep<span class="op">=</span><span class="st">" "</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of iterations: 3</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">maxIterations</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Training iteration: "</span>, <span class="va">i</span>, <span class="st">"\n"</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># train the classifier</span></span>
<span>  <span class="va">trainingSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DECIPHER/man/LearnTaxa.html" class="external-link">LearnTaxa</a></span><span class="op">(</span><span class="va">seqs</span><span class="op">[</span><span class="op">!</span><span class="va">remove</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">seqs</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="va">remove</span><span class="op">]</span>,<span class="va">taxid</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># look for problem sequences</span></span>
<span>  <span class="va">probSeqs</span> <span class="op">&lt;-</span> <span class="va">trainingSet</span><span class="op">$</span><span class="va">problemSequences</span><span class="op">$</span><span class="va">Index</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of problem sequences: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">probSeqs</span><span class="op">)</span>, <span class="st">"\n"</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Exit if no more problem sequences or same problems as previous or reach max Iter</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">probSeqs</span><span class="op">)</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"No problem sequences remaining.\n"</span><span class="op">)</span></span>
<span>    <span class="kw">break</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">probSeqs</span><span class="op">)</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">probSeqsPrev</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">probSeqsPrev</span><span class="op">==</span><span class="va">probSeqs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Iterations converged.\n"</span><span class="op">)</span></span>
<span>    <span class="kw">break</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="va">maxIterations</span><span class="op">)</span></span>
<span>    <span class="kw">break</span></span>
<span></span>
<span>  </span>
<span>  <span class="co"># remove any problem sequences</span></span>
<span></span>
<span>  <span class="va">probSeqsPrev</span> <span class="op">&lt;-</span> <span class="va">probSeqs</span></span>
<span>  </span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="va">remove</span><span class="op">)</span><span class="op">[</span><span class="va">probSeqs</span><span class="op">]</span></span>
<span>  <span class="va">remove</span><span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="co"># remove all problem sequences</span></span>
<span>  </span>
<span>  <span class="va">df.problems</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">index</span>, <span class="va">trainingSet</span><span class="op">$</span><span class="va">problemSequences</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">allowGroupRemoval</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># replace any removed groups</span></span>
<span>    <span class="va">missing</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="va">u_groups</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">groups</span><span class="op">[</span><span class="op">!</span><span class="va">remove</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">missing</span> <span class="op">&lt;-</span> <span class="va">u_groups</span><span class="op">[</span><span class="va">missing</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">missing</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">index</span><span class="op">[</span><span class="va">groups</span><span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">missing</span><span class="op">]</span></span>
<span>      <span class="va">remove</span><span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span> <span class="co"># don't remove</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#&gt; Training iteration: 1</span></span>
<span><span class="co">#&gt; ================================================================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time difference of 976.07 secs</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of problem sequences: 9</span></span>
<span><span class="co">#&gt; Training iteration: 2</span></span>
<span><span class="co">#&gt; ================================================================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time difference of 846.92 secs</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of problem sequences: 5</span></span>
<span><span class="co">#&gt; Training iteration: 3</span></span>
<span><span class="co">#&gt; ================================================================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time difference of 882.58 secs</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of problem sequences: 5</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="save-problematic-sequences">Save problematic sequences<a class="anchor" aria-label="anchor" href="#save-problematic-sequences"></a>
</h3>
<p>Problematic sequences are sequences that are not assigned to the
group they should belong to during the training process. They are
removed for the next iteration. They point out to incoherences in the
reference database.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Total number of sequences eliminated: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">remove</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of remaining problem sequences: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">probSeqs</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df.problems</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce</a></span><span class="op">(</span><span class="va">df.problems</span>, <span class="va">bind_rows</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Index</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">df.problems</span>, <span class="va">file_problems</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df.problems</span>, <span class="fl">20</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">800</span>, caption <span class="op">=</span> <span class="st">"First 20 problematic sequences."</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="save-training-set">Save training set<a class="anchor" aria-label="anchor" href="#save-training-set"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">trainingSet</span>,<span class="va">file_trained</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="assign-small-metabarcoding-data-set">Assign small metabarcoding data set<a class="anchor" aria-label="anchor" href="#assign-small-metabarcoding-data-set"></a>
</h2>
<div class="section level3">
<h3 id="files">Files<a class="anchor" aria-label="anchor" href="#files"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">taxo_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"kingdom"</span>, <span class="st">"supergroup"</span>, <span class="st">"division"</span>, <span class="st">"class"</span>, <span class="st">"order"</span>, <span class="st">"family"</span>, <span class="st">"genus"</span>, <span class="st">"species"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">file_to_assign</span> <span class="op">=</span> <span class="st">"examples/Singapore ASV_sample.fasta"</span></span>
<span><span class="va">file_to_assign_xlsx</span> <span class="op">=</span> <span class="st">"examples/Singapore ASV_sample.xlsx"</span></span>
<span><span class="va">file_assigned</span> <span class="op">=</span> <span class="st">"examples/Singapore ASV_sample.decipher.4.14.0.rds"</span></span>
<span><span class="va">file_assigned_xlsx</span> <span class="op">=</span> <span class="st">"examples/Singapore ASV_sample.decipher.4.14.0.xlsx"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="assign">Assign<a class="anchor" aria-label="anchor" href="#assign"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Read training set </span></span>
<span>  <span class="va">trainingSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">file_trained</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read sequences to assign</span></span>
<span>  <span class="va">asv_to_assign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html" class="external-link">import</a></span><span class="op">(</span><span class="va">file_to_assign_xlsx</span><span class="op">)</span></span>
<span>  <span class="va">seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Biostrings/man/XStringSet-io.html" class="external-link">readDNAStringSet</a></span><span class="op">(</span><span class="va">file_to_assign</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the taxonomy from the training set</span></span>
<span></span>
<span>  <span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DECIPHER/man/IdTaxa.html" class="external-link">IdTaxa</a></span><span class="op">(</span><span class="va">seq</span>,</span>
<span>                <span class="va">trainingSet</span>,</span>
<span>                type<span class="op">=</span><span class="st">"extended"</span>,</span>
<span>                strand<span class="op">=</span><span class="st">"top"</span>,</span>
<span>                threshold<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">ids</span></span>
<span>  </span>
<span><span class="co">#&gt; ================================================================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time difference of 7.47 secs</span></span>
<span>  </span>
<span>  <span class="va">ids</span></span>
<span><span class="co">#&gt;   A test set of class 'Taxa' with length 99</span></span>
<span><span class="co">#&gt;      confidence name                 taxon</span></span>
<span><span class="co">#&gt;  [1]         6% asv_0004             Root; Bacteria; Bacteria_X; Proteobacter...</span></span>
<span><span class="co">#&gt;  [2]        50% asv_2263             Root; Eukaryota; Alveolata; Dinoflagella...</span></span>
<span><span class="co">#&gt;  [3]        36% asv_0664             Root; Eukaryota; Alveolata; Dinoflagella...</span></span>
<span><span class="co">#&gt;  [4]        26% asv_1095             Root; Bacteria; Bacteria_X; Proteobacter...</span></span>
<span><span class="co">#&gt;  [5]        24% asv_0953             Root; Bacteria; Bacteria_X; Proteobacter...</span></span>
<span><span class="co">#&gt;  ...        ... ...                  ...</span></span>
<span><span class="co">#&gt; [95]        13% asv_2793             Root; Eukaryota; Stramenopiles; Pseudofu...</span></span>
<span><span class="co">#&gt; [96]         3% asv_2348             Root; Bacteria; Bacteria_X; Proteobacter...</span></span>
<span><span class="co">#&gt; [97]        56% asv_1507             Root; Eukaryota; Alveolata; Dinoflagella...</span></span>
<span><span class="co">#&gt; [98]         2% asv_1151             Root; Eukaryota; Opisthokonta; Metazoa; ...</span></span>
<span><span class="co">#&gt; [99]        13% asv_2741             Root; Bacteria; Bacteria_X; Proteobacter...</span></span>
<span></span>
<span><span class="co"># Transform to a dataframe</span></span>
<span><span class="co"># Note: ids are provided as a list so we need to transform to dataframe</span></span>
<span></span>
<span><span class="co"># Transform to a dataframe</span></span>
<span><span class="co"># Note: ids are provided as a list so we need to transform to dataframe</span></span>
<span></span>
<span>  <span class="va">n_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span></span>
<span>  <span class="va">df_rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Go through all the elements of the list</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_seq</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">seq_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ids</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">taxonomy</span><span class="op">&lt;-</span> <span class="va">ids</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">taxon</span></span>
<span>  <span class="va">confidence</span> <span class="op">&lt;-</span> <span class="va">ids</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">confidence</span></span>
<span>  <span class="va">df_rows</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">seq_name</span>, <span class="va">taxonomy</span>, <span class="va">confidence</span>, taxo_level<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Root"</span>, <span class="va">taxo_levels</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce</a></span><span class="op">(</span><span class="va">df_rows</span>, <span class="va">bind_rows</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">taxo_level</span> <span class="op">!=</span><span class="st">"Root"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">taxo_level</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">taxonomy</span>, <span class="va">confidence</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save to file</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">file_assigned</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge with original ASV file</span></span>
<span>  <span class="va">asv_assigned</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">asv_to_assign</span>, <span class="va">df</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">sequence</span>, .after <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">last_col</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save as xlsx file</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rio/man/export.html" class="external-link">export</a></span><span class="op">(</span><span class="va">asv_assigned</span>, <span class="va">file_assigned_xlsx</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display first 20 ASVs</span></span>
<span>  <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">asv_assigned</span>, <span class="fl">20</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">800</span>, caption <span class="op">=</span> <span class="st">"First 20 ASV reassigned."</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Daniel Vaulot.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
